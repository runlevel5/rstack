name: CI

on:
  pull_request:
    branches:
      - master
  push:
    branches:
      - master

env:
  RUSTFLAGS: -D warnings
  RUST_BACKTRACE: full
  STABLE_VERSION: 1.82.0

jobs:
  test:
    name: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Install Rust
        run: |
          rustup update $STABLE_VERSION
          rustup default $STABLE_VERSION
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libunwind-dev libdw-dev
      - uses: Swatinem/rust-cache@v2
      - name: Test everything
        run: cargo test
      - name: Test rstack with libdw
        run: cargo test --manifest-path rstack/Cargo.toml --no-default-features --features dw
      - name: Test libunwind with features
        run: cargo test --manifest-path unwind/Cargo.toml --all-features
      - name: Dw systest
        run: cargo run --manifest-path dw-systest/Cargo.toml
  libunwind:
    strategy:
      fail-fast: false
      matrix:
        target:
          - x86_64
          - i686
          - aarch64
          - powerpc64
        version:
          - 1.2.1
          - 1.4.0
          - 1.6.2

    name: libunwind ${{ matrix.target }} ${{ matrix.version }}
    runs-on: ubuntu-latest
    env:
      PKG_CONFIG_ALLOW_CROSS: 1
      CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc
      CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_RUNNER: qemu-aarch64 -L /usr/aarch64-linux-gnu
      CARGO_TARGET_POWERPC64_UNKNOWN_LINUX_GNU_LINKER: powerpc64-linux-gnu-gcc
      CARGO_TARGET_POWERPC64_UNKNOWN_LINUX_GNU_RUNNER: qemu-ppc64 -L /usr/powerpc64-linux-gnu
    steps:
      - uses: actions/checkout@v6
      - name: Install Rust
        run: |
          rustup update $STABLE_VERSION
          rustup default $STABLE_VERSION
          rustup target add ${{ matrix.target }}-unknown-linux-gnu
      - name: Install cross compiler
        run: |
          case ${{ matrix.target }} in
            x86_64)
              exit 0
              ;;
            i686)
              packages=gcc-multilib
              ;;
            aarch64)
              packages="gcc-aarch64-linux-gnu g++-aarch64-linux-gnu qemu-user"
              ;;
            powerpc64)
              packages="gcc-powerpc64-linux-gnu g++-powerpc64-linux-gnu qemu-user"
              ;;
          esac

          sudo apt-get update
          sudo apt-get install -y $packages
      - name: Install debugging tools
        run: |
          sudo apt-get update
          sudo apt-get install -y gdb
      - name: Libunwind cache
        id: libunwind-cache
        uses: actions/cache@v5
        with:
          path: ~/libunwind
          key: libunwind-${{ matrix.version }}-${{ matrix.target }}-v12-patched-debug
      - name: Build libunwind
        if: ${{ !steps.libunwind-cache.outputs.cache-hit }}
        run: |
          # libunwind < 1.5.0 needs -fcommon due to GCC 10+ defaulting to -fno-common
          fcommon_flag=""
          if [[ "${{ matrix.version }}" < "1.5.0" ]]; then
            fcommon_flag="-fcommon"
          fi

          # Enable debug logging: UNW_DEBUG_LEVEL controls verbosity (1-16)
          # -DDEBUG enables Debug() macro, -DCONSERVATIVE disables optimizations
          case ${{ matrix.target }} in
            x86_64)
              args="CFLAGS=\"-g3 -O0 -DDEBUG -DCONSERVATIVE $fcommon_flag\" CPPFLAGS=\"-DDEBUG\""
              ;;
            i686)
              args="CFLAGS=\"-g3 -O0 -m32 -DDEBUG -DCONSERVATIVE $fcommon_flag\" CPPFLAGS=\"-DDEBUG\""
              ;;
            aarch64)
              args="CC=aarch64-linux-gnu-gcc CXX=aarch64-linux-gnu-g++ CFLAGS=\"-g3 -O0 -DDEBUG -DCONSERVATIVE $fcommon_flag\" CPPFLAGS=\"-DDEBUG\""
              ;;
            powerpc64)
              args="CC=powerpc64-linux-gnu-gcc CXX=powerpc64-linux-gnu-g++ CFLAGS=\"-g3 -O0 -DDEBUG -DCONSERVATIVE $fcommon_flag\" CPPFLAGS=\"-DDEBUG\""
              ;;
          esac

          curl -L https://download-mirror.savannah.nongnu.org/releases/libunwind/libunwind-${{ matrix.version }}.tar.gz | tar -C /tmp -xzf -
          cd /tmp/libunwind-${{ matrix.version }}

          # Apply downstream patch to fix SIGSEGV in access_reg() due to NULL ucontext
          # See: https://github.com/libunwind/libunwind/issues/938
          echo "=== Applying patch ==="
          patch -p1 --verbose < $GITHUB_WORKSPACE/.github/patches/libunwind-${{ matrix.version }}-null-uc-check.patch || true
          
          # Show the patched files to verify
          echo "=== Patched access_reg in x86/Ginit.c ==="
          grep -A 20 "^access_reg" src/x86/Ginit.c 2>/dev/null | head -30 || true
          echo "=== Patched access_reg in x86_64/Ginit.c ==="
          grep -A 20 "^access_reg" src/x86_64/Ginit.c 2>/dev/null | head -30 || true
          echo "=== Patched x86_r_uc_addr in x86/Gos-linux.c ==="
          grep -A 15 "^x86_r_uc_addr" src/x86/Gos-linux.c 2>/dev/null | head -20 || true
          echo "=== Patched x86_64_r_uc_addr in x86_64/Gos-linux.c ==="
          grep -A 15 "^x86_64_r_uc_addr" src/x86_64/Gos-linux.c 2>/dev/null | head -20 || true

          eval ./configure --enable-debug --enable-debug-frame --disable-static --host ${{ matrix.target }}-linux-gnu --target ${{ matrix.target }}-linux-gnu --prefix=$HOME/libunwind $args
          # Only build src directory to avoid test build failures with old libunwind versions
          make -C src -j$(nproc) V=1
          make -C src install
          # Install headers manually (make -C include install doesn't work standalone)
          mkdir -p $HOME/libunwind/include
          cp include/*.h $HOME/libunwind/include/
      - name: Debug - List installed libunwind files
        run: |
          echo "=== Installed files in ~/libunwind ==="
          find ~/libunwind -type f | head -50
          echo "=== pkg-config directories ==="
          ls -la ~/libunwind/lib/pkgconfig/ 2>/dev/null || echo "lib/pkgconfig not found"
          ls -la ~/libunwind/lib64/pkgconfig/ 2>/dev/null || echo "lib64/pkgconfig not found"
          echo "=== .pc file contents ==="
          cat ~/libunwind/lib/pkgconfig/*.pc ~/libunwind/lib64/pkgconfig/*.pc 2>/dev/null || echo "No .pc files found"
      - name: Setup environment variables
        run: |
          # libunwind installs to lib64 on some architectures (e.g. powerpc64)
          echo "PKG_CONFIG_PATH=$HOME/libunwind/lib/pkgconfig:$HOME/libunwind/lib64/pkgconfig" >> $GITHUB_ENV
          echo "LD_LIBRARY_PATH=$HOME/libunwind/lib:$HOME/libunwind/lib64" >> $GITHUB_ENV
      - uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.target }}-${{ matrix.version }}
      - name: Systest
        run: cargo run --manifest-path unwind-systest/Cargo.toml --target ${{ matrix.target }}-unknown-linux-gnu
      - name: Unwind test
        env:
          # Enable libunwind debug output (level 1-16, higher = more verbose)
          UNW_DEBUG_LEVEL: "16"
        run: |
          # Build the test first
          cargo test --manifest-path unwind/Cargo.toml --target ${{ matrix.target }}-unknown-linux-gnu --no-run 2>&1 | tee build.log
          
          # Find the test binary
          TEST_BIN=$(cargo test --manifest-path unwind/Cargo.toml --target ${{ matrix.target }}-unknown-linux-gnu --no-run 2>&1 | grep -oP 'Executable.*\(\K[^)]+' | head -1)
          echo "Test binary: $TEST_BIN"
          
          # Run the test with debug output, capturing any crash
          echo "=== Running test with UNW_DEBUG_LEVEL=16 ==="
          if ! cargo test --manifest-path unwind/Cargo.toml --target ${{ matrix.target }}-unknown-linux-gnu 2>&1; then
            echo "=== Test failed, running with GDB for backtrace ==="
            # Enable core dumps
            ulimit -c unlimited
            echo "core" | sudo tee /proc/sys/kernel/core_pattern
            
            # Try to get a backtrace with GDB
            if [ -n "$TEST_BIN" ] && [ -f "$TEST_BIN" ]; then
              echo "=== Running test under GDB ==="
              gdb -batch -ex "set pagination off" -ex "run" -ex "bt full" -ex "info registers" -ex "quit" "$TEST_BIN" 2>&1 || true
            fi
            
            exit 1
          fi
